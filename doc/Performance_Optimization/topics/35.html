<!--create by iword1.0 pro, http://www.voland.com.cn-->
<!-- saved from url=(0026)http://www.runqian.com.cn/ -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>5.1 Ordered grouping and aggregating</title>
<link rel="stylesheet" href="../images/template.css" type="text/css" />
<link rel="stylesheet" href="document.css" type="text/css" />
<script language="JavaScript" src="../resource/url.js"></script>
</head>

<body>

<div id="content-bg">
	<div id="centent">
	<div id="centent-title"><h2 style='margin-top:8.15pt;margin-right:0cm;margin-bottom:8.15pt;margin-left:
0cm;text-indent:0cm;mso-list:l0 level2 lfo1'><span
lang=EN-US style='mso-fareast-font-family:"Times New Roman"'><span
style='mso-list:Ignore'>5.1<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span lang=EN-US>Ordered grouping and
aggregating</span></h2></div>
	<p class=MsoNormal><span lang=EN-US>If the data table is ordered by grouping
keys, we can implement the <b>ordered grouping </b>algorithm.</span></p>

<p class=MsoNormal><span lang=EN-US>The process of ordered grouping is very
simple, you only need to compare the key value of the current record and the
last grouped subset when traversing. If two values are the same, continue to put
this record into this grouped subset. On the contrary, if two values are
different, it indicates that this grouped subset has been calculated completely,
in this case, re-create a new grouped subset, and then put this record into the
new subset. Repeat these steps until the end of the traversal, and you can get
all grouped subsets.</span></p>

<p class=MsoNormal><span lang=EN-US>Similarly, for the big data, the more common
way is to obtain the aggregation value of each grouped subset. In this case,
only one grouped result set needs to be kept. When traversing at a record,
judge the grouping key value so as to decide whether to accumulate the current
record value to the last grouped record or generate a new grouped record. This
algorithm applies to all accumulable aggregation operations (describable by
iteration function).</span></p>

<p class=MsoNormal><span lang=EN-US>The ordered grouping only needs to compare
adjacent records, so its complexity is very low, and the luck problem in hash
grouping does not exist in this algorithm. The records in grouped subsets or
grouped result set are calculated one by one, thus it will not change the
calculated grouped subsets and grouped records when a new data is traversed.
Such computing process does not need a large memory space to store calculation
results, which is well suited for returning the results in the form of a
cursor, therefore, it is naturally suitable for big grouping.</span></p>

<p class=MsoNormal><span lang=EN-US>In fact, we introduced the sort grouping of
big grouping earlier, its second round uses exactly this algorithm.</span></p>

<p class=MsoNormal><span lang=EN-US>For instance, for the orders ordered by
time, the total amount of orders per day can be calculated by ordered grouping
algorithm:</span></p>

<table class=MsoNormalTable border=1 cellspacing=0 cellpadding=0 width=524
 style='border-collapse:collapse;mso-table-layout-alt:fixed;border:none;
 mso-border-top-alt:black;mso-border-left-alt:black;mso-border-bottom-alt:#B2B2B2;
 mso-border-right-alt:#B2B2B2;mso-border-style-alt:solid;mso-border-width-alt:
 .5pt;mso-yfti-tbllook:1184;mso-padding-alt:0cm 0cm 0cm 0cm;mso-border-insideh:
 .5pt solid #B2B2B2;mso-border-insidev:.5pt solid #B2B2B2'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;page-break-inside:avoid;
  height:14.15pt'>
  <td width=47 valign=top style='width:1.0cm;border:solid black 1.0pt;
  border-right:solid windowtext 1.0pt;mso-border-alt:solid black .5pt;
  mso-border-right-alt:solid windowtext .5pt;background:#DDDDDD;padding:0cm 0cm 0cm 0cm;
  height:14.15pt'>
  <p class=TabLabel style='margin-top:8.15pt;margin-right:0cm;margin-bottom:
  8.15pt;margin-left:0cm'><span lang=EN-US style='font-family:"Times New Roman","serif"'>&nbsp;</span></p>
  </td>
  <td width=487 valign=top style='width:292.05pt;border:solid windowtext 1.0pt;
  border-left:none;mso-border-left-alt:solid windowtext .5pt;mso-border-alt:
  solid windowtext .5pt;background:#DDDDDD;padding:0cm 0cm 0cm 0cm;height:14.15pt'>
  <p class=TabLabel style='margin-top:8.15pt;margin-right:0cm;margin-bottom:
  8.15pt;margin-left:0cm'><span lang=EN-US style='font-family:"Times New Roman","serif"'>A</span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:1;page-break-inside:avoid;height:14.15pt'>
  <td width=47 style='width:1.0cm;border-top:none;border-left:solid black 1.0pt;
  border-bottom:solid black 1.0pt;border-right:solid windowtext 1.0pt;
  mso-border-top-alt:solid black .5pt;mso-border-alt:solid black .5pt;
  mso-border-right-alt:solid windowtext .5pt;background:#DDDDDD;padding:0cm 0cm 0cm 0cm;
  height:14.15pt'>
  <p class=TabLabel style='margin-top:8.15pt;margin-right:0cm;margin-bottom:
  8.15pt;margin-left:0cm'><span lang=EN-US style='font-family:"Times New Roman","serif"'>1</span></p>
  </td>
  <td width=487 valign=top style='width:292.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  mso-border-top-alt:solid windowtext .5pt;mso-border-left-alt:solid windowtext .5pt;
  mso-border-alt:solid windowtext .5pt;padding:0cm 0cm 0cm 0cm;height:14.15pt'>
  <p class=MsoNormal><span class=code><span lang=EN-US style='mso-bidi-font-size:
  10.5pt;font-family:"Times New Roman","serif";mso-fareast-font-family:楷体;
  font-weight:normal'>=file(&quot;orders.btx&quot;).cursor@b()</span></span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:2;mso-yfti-lastrow:yes;page-break-inside:avoid;
  height:14.15pt'>
  <td width=47 style='width:1.0cm;border-top:none;border-left:solid black 1.0pt;
  border-bottom:solid black 1.0pt;border-right:solid windowtext 1.0pt;
  mso-border-top-alt:solid black .5pt;mso-border-alt:solid black .5pt;
  mso-border-right-alt:solid windowtext .5pt;background:#DDDDDD;padding:0cm 0cm 0cm 0cm;
  height:14.15pt'>
  <p class=TabLabel style='margin-top:8.15pt;margin-right:0cm;margin-bottom:
  8.15pt;margin-left:0cm'><span lang=EN-US style='font-family:"Times New Roman","serif"'>2</span></p>
  </td>
  <td width=487 valign=top style='width:292.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  mso-border-top-alt:solid windowtext .5pt;mso-border-left-alt:solid windowtext .5pt;
  mso-border-alt:solid windowtext .5pt;padding:0cm 0cm 0cm 0cm;height:14.15pt'>
  <p class=MsoNormal><span class=code><span lang=EN-US style='mso-bidi-font-size:
  10.5pt;font-family:"Times New Roman","serif";mso-fareast-font-family:楷体;
  font-weight:normal'>=A1.groups@o(dt;sum(amount))</span></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>In SPL, the groups@o() represents the
ordered grouping, yet here still returns a table sequence, using groups() is
considered as small grouping.</span></p>

<p class=MsoNormal><span lang=EN-US>The groups@o() for small grouping can work
on multi-cursor. The data table ordered by grouping key values can be deemed
that it is composed of successive grouped subsets. Segmentation does not
necessarily happen between two grouped subsets (possibly within a certain grouped
subset), but groups@o() will finally adjust the calculation result.</span></p>

<p class=MsoNormal><span lang=EN-US>SPL does not provide a corresponding groupx@o(),
the ordered grouping algorithm to return a big result uses another function:</span></p>

<table class=MsoNormalTable border=1 cellspacing=0 cellpadding=0 width=524
 style='border-collapse:collapse;mso-table-layout-alt:fixed;border:none;
 mso-border-top-alt:black;mso-border-left-alt:black;mso-border-bottom-alt:#B2B2B2;
 mso-border-right-alt:#B2B2B2;mso-border-style-alt:solid;mso-border-width-alt:
 .5pt;mso-yfti-tbllook:1184;mso-padding-alt:0cm 0cm 0cm 0cm;mso-border-insideh:
 .5pt solid #B2B2B2;mso-border-insidev:.5pt solid #B2B2B2'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;page-break-inside:avoid;
  height:14.15pt'>
  <td width=47 valign=top style='width:1.0cm;border:solid black 1.0pt;
  border-right:solid windowtext 1.0pt;mso-border-alt:solid black .5pt;
  mso-border-right-alt:solid windowtext .5pt;background:#DDDDDD;padding:0cm 0cm 0cm 0cm;
  height:14.15pt'>
  <p class=TabLabel style='margin-top:8.15pt;margin-right:0cm;margin-bottom:
  8.15pt;margin-left:0cm'><span lang=EN-US style='font-family:"Times New Roman","serif"'>&nbsp;</span></p>
  </td>
  <td width=487 valign=top style='width:292.05pt;border:solid windowtext 1.0pt;
  border-left:none;mso-border-left-alt:solid windowtext .5pt;mso-border-alt:
  solid windowtext .5pt;background:#DDDDDD;padding:0cm 0cm 0cm 0cm;height:14.15pt'>
  <p class=TabLabel style='margin-top:8.15pt;margin-right:0cm;margin-bottom:
  8.15pt;margin-left:0cm'><span lang=EN-US style='font-family:"Times New Roman","serif"'>A</span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:1;page-break-inside:avoid;height:14.15pt'>
  <td width=47 style='width:1.0cm;border-top:none;border-left:solid black 1.0pt;
  border-bottom:solid black 1.0pt;border-right:solid windowtext 1.0pt;
  mso-border-top-alt:solid black .5pt;mso-border-alt:solid black .5pt;
  mso-border-right-alt:solid windowtext .5pt;background:#DDDDDD;padding:0cm 0cm 0cm 0cm;
  height:14.15pt'>
  <p class=TabLabel style='margin-top:8.15pt;margin-right:0cm;margin-bottom:
  8.15pt;margin-left:0cm'><span lang=EN-US style='font-family:"Times New Roman","serif"'>1</span></p>
  </td>
  <td width=487 valign=top style='width:292.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  mso-border-top-alt:solid windowtext .5pt;mso-border-left-alt:solid windowtext .5pt;
  mso-border-alt:solid windowtext .5pt;padding:0cm 0cm 0cm 0cm;height:14.15pt'>
  <p class=MsoNormal><span class=code><span lang=EN-US style='mso-bidi-font-size:
  10.5pt;font-family:"Times New Roman","serif";mso-fareast-font-family:楷体;
  font-weight:normal'>=file(&quot;orders.btx&quot;).cursor@b()</span></span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:2;page-break-inside:avoid;height:14.15pt'>
  <td width=47 style='width:1.0cm;border-top:none;border-left:solid black 1.0pt;
  border-bottom:solid black 1.0pt;border-right:solid windowtext 1.0pt;
  mso-border-top-alt:solid black .5pt;mso-border-alt:solid black .5pt;
  mso-border-right-alt:solid windowtext .5pt;background:#DDDDDD;padding:0cm 0cm 0cm 0cm;
  height:14.15pt'>
  <p class=TabLabel style='margin-top:8.15pt;margin-right:0cm;margin-bottom:
  8.15pt;margin-left:0cm'><span lang=EN-US style='font-family:"Times New Roman","serif"'>2</span></p>
  </td>
  <td width=487 valign=top style='width:292.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  mso-border-top-alt:solid windowtext .5pt;mso-border-left-alt:solid windowtext .5pt;
  mso-border-alt:solid windowtext .5pt;padding:0cm 0cm 0cm 0cm;height:14.15pt'>
  <p class=MsoNormal><span class=code><span lang=EN-US style='mso-bidi-font-size:
  10.5pt;font-family:"Times New Roman","serif";mso-fareast-font-family:楷体;
  font-weight:normal'>=A1.group(dt).new(dt,~.sum(amount))</span></span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:3;mso-yfti-lastrow:yes;page-break-inside:avoid;
  height:14.15pt'>
  <td width=47 style='width:1.0cm;border-top:none;border-left:solid black 1.0pt;
  border-bottom:solid black 1.0pt;border-right:solid windowtext 1.0pt;
  mso-border-top-alt:solid black .5pt;mso-border-alt:solid black .5pt;
  mso-border-right-alt:solid windowtext .5pt;background:#DDDDDD;padding:0cm 0cm 0cm 0cm;
  height:14.15pt'>
  <p class=TabLabel style='margin-top:8.15pt;margin-right:0cm;margin-bottom:
  8.15pt;margin-left:0cm'><span lang=EN-US style='font-family:"Times New Roman","serif"'>3</span></p>
  </td>
  <td width=487 valign=top style='width:292.05pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  mso-border-top-alt:solid windowtext .5pt;mso-border-left-alt:solid windowtext .5pt;
  mso-border-alt:solid windowtext .5pt;padding:0cm 0cm 0cm 0cm;height:14.15pt'>
  <p class=MsoNormal><span class=code><span lang=EN-US style='mso-bidi-font-size:
  10.5pt;font-family:"Times New Roman","serif";mso-fareast-font-family:楷体;
  font-weight:normal'>=A1.group(dt;sum(amount))</span></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>By default, the group() function on the cursor
will consider that the cursor is ordered by grouping key values, it will return
a cursor, and each grouped subset can be taken out in turn, after that, further
operations can be performed. If the aggregation expression is written in the
parameters, the cumulative method will be used directly to perform the
aggregation, in this case, a cursor will still be returned, and however, the
cursor members will be the grouped records consisting of grouped aggregation
values.</span></p>

<p class=MsoNormal><span lang=EN-US>Here, A2 and A3 perform the operations of
the same result in different ways. In the way of A2, each grouped subset needs
to be taken out, thus it requires that the grouped subset cannot be too large; while
in the way of A3, the calculation process of iteration function is used to
perform the aggregation calculation, which can calculate normally when it
encounters a big grouped subset. If you only need to get the grouped
aggregation value, it is more advantageous to use A3 code.</span></p>

<p class=MsoNormal><span lang=EN-US>Both A2 and A3 are cursors, and fetch() is
still needed to take out calculation data. Moreover, the group() function is a
delayed cursor, actual calculation will be performed only while data-fetching.</span></p>

<p class=MsoNormal><span lang=EN-US>For big grouping, group() cannot directly support
the multi-cursor. If the segmentation position falls within a certain grouped
subset, an incorrect calculation result will occur. Theoretically, we can adopt
the method of discarding the head and complementing the tail discussed in the text
file segmentation section, which is described as follows: starting from the
segment position (except the first segment), find the next record with a
different grouping key value, then start traversing this segment. After this
segment is traversed, continue to the next segment and fetch a record and
continue to traverse until this grouped subset is completely traversed. In this
way, a correct calculation result can be ensured in case the multi-cursor is
used for segmentation.</span></p>

<p class=MsoNormal><span lang=EN-US>Unlike a text file, however, a certain grouped
subset may be very large, which may cause a very large &quot;head&quot; to be discarded
in the above-mentioned method, resulting in a decrease in performance due to
repeated read. Moreover, since it is not clear how the cursor is calculated out
(cursor may come from various sources) during the execution of group()
function, the action of the said method should be well handled when the data
table is segmented, it requires you to know which field the data table is
sorted by when segmenting.</span></p>

<p class=MsoNormal><span lang=EN-US>SPL's composite table provides another
segmentation mechanism. Because SPL needs to specify the data structure in
advance when creating a composite table, therefore, some information like
ordered fields is known in advance, it can ensure that the segmentation point
will definitely fall between the grouped subsets when segmenting. The text
files and bin files do not need to specify the data table structure in advance,
this mechanism is not provided.</span></p>

<table class=MsoNormalTable border=1 cellspacing=0 cellpadding=0 width=555
 style='border-collapse:collapse;mso-table-layout-alt:fixed;border:none;
 mso-border-top-alt:black;mso-border-left-alt:black;mso-border-bottom-alt:#B2B2B2;
 mso-border-right-alt:#B2B2B2;mso-border-style-alt:solid;mso-border-width-alt:
 .5pt;mso-yfti-tbllook:1184;mso-padding-alt:0cm 0cm 0cm 0cm;mso-border-insideh:
 .5pt solid #B2B2B2;mso-border-insidev:.5pt solid #B2B2B2'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;page-break-inside:avoid;
  height:14.15pt'>
  <td width=47 valign=top style='width:1.0cm;border:solid black 1.0pt;
  border-right:solid windowtext 1.0pt;mso-border-alt:solid black .5pt;
  mso-border-right-alt:solid windowtext .5pt;background:#DDDDDD;padding:0cm 0cm 0cm 0cm;
  height:14.15pt'>
  <p class=TabLabel style='margin-top:8.15pt;margin-right:0cm;margin-bottom:
  8.15pt;margin-left:0cm'><span lang=EN-US style='font-family:"Times New Roman","serif"'>&nbsp;</span></p>
  </td>
  <td width=518 valign=top style='width:310.55pt;border:solid windowtext 1.0pt;
  border-left:none;mso-border-left-alt:solid windowtext .5pt;mso-border-alt:
  solid windowtext .5pt;background:#DDDDDD;padding:0cm 0cm 0cm 0cm;height:14.15pt'>
  <p class=TabLabel style='margin-top:8.15pt;margin-right:0cm;margin-bottom:
  8.15pt;margin-left:0cm'><span lang=EN-US style='font-family:"Times New Roman","serif"'>A</span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:1;page-break-inside:avoid;height:14.15pt'>
  <td width=47 style='width:1.0cm;border-top:none;border-left:solid black 1.0pt;
  border-bottom:solid black 1.0pt;border-right:solid windowtext 1.0pt;
  mso-border-top-alt:solid black .5pt;mso-border-alt:solid black .5pt;
  mso-border-right-alt:solid windowtext .5pt;background:#DDDDDD;padding:0cm 0cm 0cm 0cm;
  height:14.15pt'>
  <p class=TabLabel style='margin-top:8.15pt;margin-right:0cm;margin-bottom:
  8.15pt;margin-left:0cm'><span lang=EN-US style='font-family:"Times New Roman","serif"'>1</span></p>
  </td>
  <td width=518 valign=top style='width:310.55pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  mso-border-top-alt:solid windowtext .5pt;mso-border-left-alt:solid windowtext .5pt;
  mso-border-alt:solid windowtext .5pt;padding:0cm 0cm 0cm 0cm;height:14.15pt'>
  <p class=MsoNormal><span class=code><span lang=EN-US style='mso-bidi-font-size:
  10.5pt;font-family:"Times New Roman","serif";mso-fareast-font-family:楷体;
  font-weight:normal'>=file(&quot;orders.ctx&quot;).create@p(#dt,…)</span></span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:2;page-break-inside:avoid;height:14.15pt'>
  <td width=47 style='width:1.0cm;border-top:none;border-left:solid black 1.0pt;
  border-bottom:solid black 1.0pt;border-right:solid windowtext 1.0pt;
  mso-border-top-alt:solid black .5pt;mso-border-alt:solid black .5pt;
  mso-border-right-alt:solid windowtext .5pt;background:#DDDDDD;padding:0cm 0cm 0cm 0cm;
  height:14.15pt'>
  <p class=TabLabel style='margin-top:8.15pt;margin-right:0cm;margin-bottom:
  8.15pt;margin-left:0cm'><span lang=EN-US style='font-family:"Times New Roman","serif"'>2</span></p>
  </td>
  <td width=518 valign=top style='width:310.55pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  mso-border-top-alt:solid windowtext .5pt;mso-border-left-alt:solid windowtext .5pt;
  mso-border-alt:solid windowtext .5pt;padding:0cm 0cm 0cm 0cm;height:14.15pt'>
  <p class=MsoNormal><span class=code><span lang=EN-US style='mso-bidi-font-size:
  10.5pt;font-family:"Times New Roman","serif";mso-fareast-font-family:楷体;
  font-weight:normal'>=file(&quot;orders.ctx&quot;).open().cursor@m(dt,amount;;4)</span></span></p>
  </td>
 </tr>
 <tr style='mso-yfti-irow:3;mso-yfti-lastrow:yes;page-break-inside:avoid;
  height:14.15pt'>
  <td width=47 style='width:1.0cm;border-top:none;border-left:solid black 1.0pt;
  border-bottom:solid black 1.0pt;border-right:solid windowtext 1.0pt;
  mso-border-top-alt:solid black .5pt;mso-border-alt:solid black .5pt;
  mso-border-right-alt:solid windowtext .5pt;background:#DDDDDD;padding:0cm 0cm 0cm 0cm;
  height:14.15pt'>
  <p class=TabLabel style='margin-top:8.15pt;margin-right:0cm;margin-bottom:
  8.15pt;margin-left:0cm'><span lang=EN-US style='font-family:"Times New Roman","serif"'>3</span></p>
  </td>
  <td width=518 valign=top style='width:310.55pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  mso-border-top-alt:solid windowtext .5pt;mso-border-left-alt:solid windowtext .5pt;
  mso-border-alt:solid windowtext .5pt;padding:0cm 0cm 0cm 0cm;height:14.15pt'>
  <p class=MsoNormal><span class=code><span lang=EN-US style='mso-bidi-font-size:
  10.5pt;font-family:"Times New Roman","serif";mso-fareast-font-family:楷体;
  font-weight:normal'>=A2.group(dt;sum(amount))</span></span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=EN-US>While creating a composite table, @p can be
used to inform SPL not to put records with the same value in the first field
(usually an ordered field) into two segments while segmenting. Currently, the
segmentation processing is only provided for the first field, as the past
practice has shown that it is enough.</span></p>

<p class=MsoNormal><span lang=EN-US>Then, you can use multi-cursor to
calculate. Note that the syntax of multi-cursor for composite table are a
little different from those for text and bin files, which need to be written at
the parameters after the second semicolon.</span></p>
	</div>
	<div id="previous-next">
		<div id="next"><a href="36.html">Next</a></div>
		<div id="previous"><a href="34.html">Previous</a></div>		
	</div>
	<div id="related">
		<div class="related-title"><div class="related-title-left"></div>   Related :</div>
		<div class="related-list"><li><span style='font-family:宋体;mso-ascii-font-family:"Times New Roman";mso-hansi-font-family:"Times New Roman"'><a href="34.html">5 Ordered traversal</a></span></li>
</div>
	</div>
	<div id="footer">	
		
		
    <div class="copyright"> Copyright&reg; 2021-2023 <a href="http://www.scudata.com" target="_Blank">SCUDATA Inc. 
      </a></div>
	</div>
</div>

</body>
</html>
